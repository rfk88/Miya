# Alert/Notification Trigger Flow - Complete Documentation

## Overview
Alerts (family notifications) are generated by analyzing **trends** in vitality pillar scores (Sleep, Movement, Stress) over the last 21 days. They are NOT based on absolute values, but on **patterns and changes**.

---

## 1. TRIGGER POINTS (When alerts are computed)

### `computeTrendInsights()` is called from:
1. **DashboardView `.task`** (line 850) - On initial load
2. **Pull-to-refresh** (line 656) - When user pulls down
3. **After debug record creation** (line 783) - When you add test data
4. **After API wearable connection** (via notification handler)

---

## 2. ELIGIBILITY REQUIREMENTS (Who gets analyzed)

### Member must pass ALL of these:
- âœ… `!member.isPending` - Not a pending invite
- âœ… `member.hasScore` - Has at least one vitality score
- âœ… `member.isScoreFresh` - Score updated within last 3 days
- âœ… `!member.isMe` - **EXCLUDES the logged-in user** (only family members)
- âœ… `member.userId != nil` - Has a valid user ID

**Location**: `DashboardView.swift:1606-1615`

---

## 3. DATA REQUIREMENTS (What data is needed)

### Minimum coverage:
- **At least 7 days** of history data (`requiredMinDaysForAnyInsight = 7`)
- **21-day window** analyzed (`windowDays = 21`)
- Data fetched from `vitality_scores` table via `dataManager.fetchMemberVitalityScoreHistory(userIds:days:21)`

**Location**: `FamilyVitalityTrendEngine.swift:169`

### If coverage insufficient:
- Returns empty insights array
- Sets `hasMinimumCoverage = false`
- **No alerts will be shown**

---

## 4. ALERT RULES (How alerts are generated)

### Location: `FamilyVitalityTrendEngine.swift:352-463` (`analyzePillar`)

For each pillar (Sleep, Movement, Stress), the engine checks 3 rules:

### **Rule 1: "3-Day Streak Low"** â†’ `.attention` severity
- **Condition**: Last 3 days are ALL in the bottom quartile of the 14-day range
- **AND**: Has a consecutive streak of at least 3 days
- **Example**: If sleep scores are [90, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25], bottom quartile = 35. If last 3 days are [30, 25, 20], alert fires.

### **Rule 2: "20%+ Drop vs Baseline"** â†’ `.attention` severity
- **Condition**: Recent 3-day average is >= 20% lower than baseline 7-day average
- **Requires**: At least 5 days of baseline data
- **Example**: Baseline avg = 80, recent avg = 60 â†’ (80-60)/80 = 25% drop â†’ Alert fires

### **Rule 3: "15%+ Rebound"** â†’ `.celebrate` severity
- **Condition**: Recent 3-day average is >= 15% higher than baseline 7-day average
- **Requires**: At least 5 days of baseline data
- **Example**: Baseline avg = 60, recent avg = 75 â†’ (75-60)/60 = 25% gain â†’ Alert fires

**Important**: Rules are checked in order. First match wins. Only ONE insight per pillar per member.

---

## 5. INSIGHT SELECTION (Which insights are kept)

### Location: `FamilyVitalityTrendEngine.swift:520-547` (`selectTopInsights`)

After all insights are generated:
- **Up to 2 `.attention` insights** (prefer different members)
- **If no attention insights**: Add 1 `.celebrate` insight
- **Maximum 2 insights total** returned

---

## 6. FILTERING (What gets filtered out)

### Location: `DashboardView.swift:6019-6065` (`FamilyNotificationItem.build`)

### Filter 1: Coverage Gate
```swift
if trendCoverage?.hasMinimumCoverage == true, !trendInsights.isEmpty {
    // Only proceed if coverage is sufficient
}
```

### Filter 2: Name Filter
```swift
.filter { !$0.memberName.isEmpty }
```

### Filter 3: Relevance Filter (THE PROBLEM)
```swift
.filter { ins in
    switch ins.severity {
    case .attention, .watch:
        return isStillRelevantNegativeAlert(memberUserId: ins.memberUserId, pillar: ins.pillar)
    case .celebrate:
        return true
    }
}
```

**`isStillRelevantNegativeAlert`** (line 6003):
- Gets current pillar score from `vitalityFactors`
- **If current score >= 85**: **FILTERS OUT** the alert
- **If current score < 85**: Keeps the alert
- **If no current score available**: Keeps the alert

**This is why alerts disappear!** If the member's current score improved to 85+, the alert is suppressed even though the trend still exists.

---

## 7. UI DISPLAY CONDITIONS (When alerts appear on screen)

### Location: `DashboardView.swift:581-594`

### All of these must be true:
1. âœ… `familySnapshot != nil`
2. âœ… `familyVitalityScore != nil`
3. âœ… `!isComputingTrendInsights` (computation finished)
4. âœ… `notifications.isEmpty == false` (after filtering)

**If ANY condition fails, no notifications card is shown.**

---

## 8. THE COMPLETE FLOW

```
1. User adds debug records
   â†“
2. computeTrendInsights() called (line 783)
   â†“
3. Fetch eligible members (excludes "Me", requires hasScore, isScoreFresh)
   â†“
4. Fetch 21 days of history from Supabase
   â†“
5. FamilyVitalityTrendEngine.computeTrends() analyzes data
   â†“
6. For each eligible member:
   - Analyze Sleep pillar â†’ Check 3 rules â†’ Generate insight if match
   - Analyze Movement pillar â†’ Check 3 rules â†’ Generate insight if match
   - Analyze Stress pillar â†’ Check 3 rules â†’ Generate insight if match
   â†“
7. selectTopInsights() picks up to 2 insights (prefer attention, different members)
   â†“
8. FamilyNotificationItem.build() filters insights:
   - Coverage check (must have 7+ days)
   - Name check (must have name)
   - Relevance check (current score < 85 for negative alerts)
   â†“
9. UI checks conditions:
   - snapshot exists?
   - score exists?
   - not computing?
   - notifications not empty?
   â†“
10. If all pass â†’ FamilyNotificationsCard displayed
```

---

## 9. WHY ALERTS MIGHT NOT APPEAR

### Problem 1: Member excluded
- Member is `isMe` (logged-in user) â†’ Excluded from family trends
- Member is `isPending` â†’ Excluded
- Member has no `userId` â†’ Excluded

### Problem 2: Insufficient data
- Less than 7 days of history â†’ `hasMinimumCoverage = false` â†’ No insights
- Member's score not fresh (updated > 3 days ago) â†’ Excluded

### Problem 3: No trend pattern matches
- Last 3 days NOT in bottom quartile â†’ Rule 1 fails
- Recent avg NOT 20%+ below baseline â†’ Rule 2 fails
- Recent avg NOT 15%+ above baseline â†’ Rule 3 fails
- **Result**: No insights generated

### Problem 4: Filtered out by relevance check
- Insight generated (e.g., "3-day streak low")
- But current pillar score is >= 85
- **Result**: Alert filtered out even though trend exists

### Problem 5: UI conditions not met
- `familySnapshot` is nil â†’ No notifications shown
- `familyVitalityScore` is nil â†’ No notifications shown
- `isComputingTrendInsights` is true â†’ No notifications shown (still computing)

### Problem 6: Too many insights
- `selectTopInsights` only keeps 2 insights max
- If 3+ members have alerts, only 2 are shown

---

## 10. DEBUG CHECKLIST

When alerts don't appear, check:

1. **Member eligibility**:
   ```
   âœ… Is member.isMe == false?
   âœ… Is member.isPending == false?
   âœ… Is member.hasScore == true?
   âœ… Is member.isScoreFresh == true?
   âœ… Does member.userId exist?
   ```

2. **Data coverage**:
   ```
   âœ… Does history have >= 7 days for this member?
   âœ… Are dates within last 21 days?
   âœ… Are pillar scores (sleep/movement/stress) present?
   ```

3. **Trend rules**:
   ```
   âœ… Are last 3 days in bottom quartile? (Rule 1)
   âœ… OR is recent avg 20%+ below baseline? (Rule 2)
   âœ… OR is recent avg 15%+ above baseline? (Rule 3)
   ```

4. **Filtering**:
   ```
   âœ… Is trendCoverage.hasMinimumCoverage == true?
   âœ… Is current pillar score < 85? (for negative alerts)
   âœ… Does insight pass selectTopInsights? (max 2)
   ```

5. **UI conditions**:
   ```
   âœ… Is familySnapshot != nil?
   âœ… Is familyVitalityScore != nil?
   âœ… Is isComputingTrendInsights == false?
   ```

---

## 11. KEY FILES

- **Trigger**: `DashboardView.swift:1597` (`computeTrendInsights`)
- **Engine**: `FamilyVitalityTrendEngine.swift` (`computeTrends`, `analyzePillar`)
- **Filtering**: `DashboardView.swift:5977` (`FamilyNotificationItem.build`)
- **Display**: `DashboardView.swift:581-594` (UI conditions)

---

## 12. CURRENT ISSUE

Based on your logs:
- âœ… Trend engine generated 1 insight: "Test Â· Sleep: attention | 3-day streak in bottom quartile"
- âœ… Coverage is sufficient (14 days available)
- â“ **Likely filtered out by `isStillRelevantNegativeAlert`** if current sleep score >= 85
- â“ **OR** UI conditions not met (snapshot/score/computing state)

**Check the debug logs** for:
- `ğŸ”” NotificationFilter:` - Shows if alert was filtered
- `ğŸ”” Final notification count:` - Shows how many passed filtering
- `ğŸ”” Dashboard: Notifications not shown` - Shows which UI condition failed

